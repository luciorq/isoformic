---
title: "Preparing Isoformic Inputs"
author:
  - name: "Izabela Mamede Conceição"
  - name: "Lucio Rezende Queiroz"
date: "2025-10-01"
modified: "2025-10-17"
vignette: >
  %\VignetteIndexEntry{Preprocessing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo=FALSE, results="hide"}
knitr::opts_chunk$set(
  tidy = FALSE, cache = FALSE, dev = "png",
  message = FALSE, error = FALSE, warning = FALSE
)
```

##  Salmon: command command line interface anatomy

### From the Terminal - Salmon Command Line Interface

Below is a single-sample invocation (to be run in a Bash shell) showing the
typical arguments we used when making the mini dataset used in this vignette.

Replace the paths with yours if you want to reproduce.

More thorough information can be found on: <https://combine-lab.github.io/salmon/>.

``` bash
salmon quant \
  --libType A \                      # A -> autodetect library type from the reads
  --index /path/to/index \           # Transcriptome index (here: index built from the FASTA annotation file)
  --mates1 /path/SRR..._1.fastq \    # R1 FASTQ
  --mates2 /path/SRR..._2.fastq \    # R2 FASTQ
  --output /path/SRR..._quant \      # Output folder (contains quant.sf, aux_info/)
  --threads 8 \                      # Number of parallel threads used
  --validateMappings \               # selective-alignment (more specific, recommended)
  --d \                              # Add Terminus needed outputs
  --posBias --seqBias --gcBias \     # bias corrections (positional, sequence, GC)
  --numGibbsSamples 100              # draw inferential replicates; required for fishpond/Swish
```

### From R - `condathis` wrapper for Salmon

Caveats: currently Salmon is only available for MacOS and Linux on the [Bioconda](https://bioconda.github.io/) channel.

Therefore, this example will not work natively on Windows.
But you can use WSL2 (Windows Subsystem for Linux) on Windows 10/11 to run it.

```{r, eval=FALSE}
library(isoformic)
tx_fasta_path <- download_reference(version = "34", file_type = "fasta")
genome_fasta_path <- download_reference(version = "34", file_type = "genome_fasta")
gff_path <- download_reference(version = "34", file_type = "gff")

salmon_index(
  fasta_path = "/path/to/tx_fasta.fa",
  index_path = "/path/to/index",
  kmer_len = 31,
  num_threads = 8
)

salmon_quant(
  index_path = "/path/to/index",
  input_r1 = "/path/SRR..._1.fastq",
  input_r2 = "/path/SRR..._2.fastq",
  output_dir = "/path/SRR..._quant"
)
```

Now to run and get the isoformic tables.

```{r}
suppressPackageStartupMessages({
  library(tximport)
  library(SummarizedExperiment)
  library(fishpond)
  library(DESeq2)
})

# devtools::load_all()
library(isoformic)

# Where extdata lives
extdata_dir <- system.file("extdata", package = "isoformic")
# if (ext_base == "") {
#  ext_base <- file.path("inst", "extdata")
# }

quants_dir <- file.path(extdata_dir, "mini_quants")

gff_path <- isoformic::download_reference(version = "49", file_type = "gff")
```

## Load Salmon Quantification with tximport

Point to Salmon's `quant.sf` output files.

```{r}
# discover sample folders like SRR11498039_quant, etc.
sample_dirs <- list.dirs(quants_dir, full.names = FALSE, recursive = FALSE)

# keep only *_quant and strip the suffix for sample names
samples <- sub("_quant$", "", sample_dirs)
stopifnot(length(samples) == 6)

# define groups: "control" = first 3, "treatment" = last 3 (sorted by sample ID)
samples <- sort(samples)
condition <- c(rep("control", 3), rep("treatment", 3))

files <- file.path(quants_dir, paste0(samples, "_quant"), "quant.sf")
names(files) <- samples
stopifnot(all(file.exists(files)))

col_data <- tibble::tibble(
  files = files,
  names = samples,
  condition = factor(condition, levels = c("control", "treatment"))
)
col_data
```

Import transcriptomics data with tximport.

```{r}
txi_tx <- tximport::tximport(
  files = files,
  type = "salmon",
  txIn = TRUE,
  txOut = TRUE,
  countsFromAbundance = "no",
  dropInfReps = FALSE,
  ignoreAfterBar = TRUE
)

se_tx <- SummarizedExperiment(
  assays = list(
    counts = txi_tx$counts,
    abundance = txi_tx$abundance,
    length = txi_tx$length
  ),
  colData = col_data,
  metadata = list(
    txi = list(
      countsFromAbundance = txi_tx$countsFromAbundance
    )
  )
)
```

Convert to IsoformicExperiment object.

```{r}
iso <- as_isoformic(se_tx, gff_path)
```


Save the counts table.

```{r}
tx_to_gene_df <- tx_to_gene(iso)
head(tx_to_gene_df)

rowData(se_tx) <- row_data(iso)

iso
```

Perform transcript-level Differential Expression Analysis with fishpond.

```{r, eval=FALSE}
y <- se_tx
y <- fishpond::scaleInfReps(y)

y <- fishpond::labelKeep(y, minCount = 10, minN = 3)
y <- y[mcols(y)$keep, ]

y$condition <- factor(y$condition, levels = c("control", "case"))

# run Swish
y <- fishpond::swish(y, x = "condition")

str(y)
```

```{r}
# collect results
DET_all <- S4Vectors::mcols(y) |>
  base::as.data.frame() |>
  tibble::rownames_to_column("transcript_id") |>
  tibble::as_tibble() |>
  dplyr::left_join(tx_to_gene_df, by = "transcript_id")

DET_all
```

Summarize Transcript SummarizedExperiment to Gene level.

```{r}
se_gene <- tximeta::summarizeToGene(
  se_tx,
  tx2gene = dplyr::select(row_data(iso), transcript_id, gene_id),
  skipRanges = TRUE
)
```

Perform Gene level Differential Expression with DESeq2.

```{r, eval=TRUE}
colData(se_gene)$condition <- factor(colData(se_gene)$condition, levels = c("control", "treatment"))

assays(se_gene)$counts <- round(assays(se_gene)$counts)

dds <- DESeq2::DESeqDataSet(se_gene, design = ~condition)
dds <- dds[rowSums(DESeq2::counts(dds) >= 10) >= 3, ]
dds <- DESeq2::DESeq(dds)

res <- DESeq2::results(dds, contrast = c("condition", "treatment", "control"))

# shrink for stability on small example
if (rlang::is_installed("apeglm")) {
  message("apeglm is installed")
  shrink_type <- "apeglm"
} else {
  message("apeglm is NOT installed")
  shrink_type <- "normal"
}

res_shr <- DESeq2::lfcShrink(
  dds,
  coef = "condition_treatment_vs_control",
  res = res,
  type = shrink_type
)

res
res_shr
dea_gene_res <- base::as.data.frame(res_shr) |>
  tibble::rownames_to_column("gene_id") |>
  tibble::as_tibble() |>
  dplyr::rename(
    log2FC = log2FoldChange,
    pvalue = pvalue,
    qvalue = padj
  )


iso@dea$deg <- dea_gene_res

de_gene(iso)
```
